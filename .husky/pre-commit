#!/bin/sh

# === Protected Branch Check ===
BRANCH=$(git rev-parse --abbrev-ref HEAD)
PROTECTED_BRANCHES="^(main|master)$"

if echo "$BRANCH" | grep -qE "$PROTECTED_BRANCHES"; then
  echo "‚ùå Direct commits to '$BRANCH' are not allowed!"
  echo "   Please create a feature branch: git checkout -b feat/your-feature"
  exit 1
fi

# === Branch Naming Convention ===
BRANCH_PATTERN="^(feat|fix|chore|docs|style|refactor|test|hotfix|release)/[a-z0-9._-]+$"

if ! echo "$BRANCH" | grep -qE "$BRANCH_PATTERN"; then
  echo "‚ùå Invalid branch name: '$BRANCH'"
  echo "   Branch must follow pattern: <type>/<description>"
  echo "   Types: feat, fix, chore, docs, style, refactor, test, hotfix, release"
  echo "   Example: feat/add-user-auth, fix/login-bug"
  exit 1
fi

# === File Size Limit (5MB) ===
MAX_FILE_SIZE=5242880  # 5MB in bytes

for file in $(git diff --cached --name-only --diff-filter=ACM); do
  if [ -f "$file" ]; then
    FILE_SIZE=$(wc -c < "$file")
    if [ "$FILE_SIZE" -gt "$MAX_FILE_SIZE" ]; then
      echo "‚ùå File '$file' exceeds 5MB limit ($(echo "scale=2; $FILE_SIZE/1048576" | bc)MB)"
      echo "   Consider using Git LFS for large files"
      exit 1
    fi
  fi
done

# === Biome Lint & Format ===
pnpm exec biome check --staged --write --no-errors-on-unmatched
git update-index --again

# === TypeScript Type Check ===
pnpm exec tsc --noEmit

# === Build Check ===
echo "üî® Running build check..."
pnpm run build
